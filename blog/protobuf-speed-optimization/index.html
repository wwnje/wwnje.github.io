<!DOCTYPE html>
<html lang="en-us" dir="ltr">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Protobuf Speed Optimization &middot; blog of wwnje</title>
  <meta name="description" content="" />
  <link href="http://wwnje.github.io/css/katex.css?version=20210301" rel="stylesheet">
  
  
  
  
  <link href="http://wwnje.github.io/css/concated.min.css?version=20210301" rel="stylesheet">
  
  <style>
    body {
      background: #ecedef url("http://wwnje.github.io/test.jpg") repeat;
    }
  </style>
</head>

  <body class="single-body">
    <nav class="nav-bar side-padding">
  <h1 class="nav-header"><a href="http://wwnje.github.io/" class="nav-text">wwnje</a></h1>
  <div class="hamburger-menu">
    <button onclick="hamburgerMenuPressed.call(this)" aria-haspopup="true" aria-expanded="false" aria-controls="menu" aria-label="Menu">
      <span></span>
      <span></span>
    </button>
    <ul id="menu" class="hamburger-menu-overlay">
      <li><a href="http://wwnje.github.io/" class="hamburger-menu-overlay-link">Home</a></li>
      
      <li><a href="http://wwnje.github.io/categories/unity/" class="hamburger-menu-overlay-link">unity</a></li>
      
      
    </ul>
  </div>
</nav>

    <main class="content side-text-padding">
      <article class="post dropcase">
        <header class="post-header">
          <h1 class="post-title">Protobuf Speed Optimization</h1>
          <p class="post-date">Posted <time datetime="2019-12-31">Dec 31, 2019</time></p>
        </header>
        
        
        <p>optimization <code> Messages.Descriptor.Fields.InDeclarationOrder()</code></p>
<h2 id="original-code">Original Code</h2>
<h3 id="packetmap">PacketMap</h3>
<pre><code>public void Initialize()
{
    foreach (FieldDescriptor fieldDescriptor
        in Messages.Descriptor.Fields.InDeclarationOrder())
    {
        ushort messageType = (ushort)fieldDescriptor.FieldNumber;

        _messageTypes[fieldDescriptor.MessageType.ClrType] = messageType;
        _parsers[messageType] = fieldDescriptor.MessageType.Parser;
    }
}
</code></pre><blockquote>
<p>优化前的问题</p>
</blockquote>
<p>在游戏启动后直接加载中这段代码
<img src="http://img.orvnge.com/uploads/2001/020846384380.png" alt=""></p>
<p>可以看到这段代码耗时在User Code中占用了一半，在真机表现中，因为是在游戏启动后直接加载这段代码，所以在logo出现后会黑屏一会再出现loading界面。</p>
<h2 id="优化版本">优化版本</h2>
<p>代码耗时的最大原因是Protobuf的反射问题，所以能不能不用反射呢。优化方向有两个</p>
<ol>
<li>不放在游戏启动时进行，而是在loading时进行</li>
<li>不用反射</li>
</ol>
<p>下面是优化后的代码</p>
<h3 id="packetmaploader">PacketMapLoader</h3>
<pre><code>public class PacketMapLoader : ILaunchTask
{
    [Inject] private readonly IPacketMap _packetMap;

    public int ExecuteOrder =&gt; -1;

    public async UniTask Execute()
    {
        var stopwatch = new Stopwatch();
        stopwatch.Start();

        var messageTypes = new Dictionary&lt;Type, ushort&gt;();
        var parsers = new Dictionary&lt;ushort, MessageParser&gt;();

        var packetMapData = new PacketMapData();
        packetMapData.Init(messageTypes, parsers);
        _packetMap.InitMessages(messageTypes, parsers);

        stopwatch.Stop();
        Debug.LogFormat(
            $&quot;&lt;color=yellow&gt;PacketMapLoader Execute cost:{stopwatch.Elapsed.TotalMilliseconds}&lt;/color&gt;&quot;);
    }
}
</code></pre><p>再来看看时间是不是省了非常多，从500ms多到90ms。</p>
<p><img src="http://img.orvnge.com/uploads/2001/020849035551.png" alt=""></p>
<p>那么是怎么做到的呢，原因就是提前生成需要的代码来代替反射。这里大概有200多个网络消息，创建PacketMapData的代码我放最下面。</p>
<h3 id="packetmapdata">PacketMapData</h3>
<pre><code>public class PacketMapData
{ 
    public void Init(Dictionary&lt;Type, ushort&gt; messageTypes, Dictionary&lt;ushort, MessageParser&gt; parsers)
    {
        messageTypes.Add(typeof(Protocols.Messages.Login.LoginToLSReq), 1001);
        var parser1 = Protocols.Messages.Login.LoginToLSReq.Parser;
        parsers.Add(1001, parser1);
        ...
        ...
        messageTypes.Add(typeof(Protocols.Messages.Activity.NewYearBuyRes), 2601);
        var parser254 = Protocols.Messages.Activity.NewYearBuyRes.Parser;
        parsers.Add(2601, parser254);
    }
}
</code></pre><blockquote>
<p>不足</p>
</blockquote>
<p>但是实际上这段代码还是有不足的地方，比如loading开始时会有一点点卡顿。原因可以看以下Protobuf源码</p>
<p><img src="http://img.orvnge.com/uploads/2001/020849437095.png" alt=""></p>
<p>当我们每次获取消息的Parser时都会进行一遍new操作，比如</p>
<pre><code>var parser1 = Protocols.Messages.Login.LoginToLSReq.Parser;
</code></pre><p>而且我们有200多个消息，这也是可以优化的，优化方向就是异步处理。</p>
<h2 id="异步优化版本">异步优化版本</h2>
<p>优化的重点就是用异步来做，但是时间总耗时增加了很多，所以用哪个看项目需要。</p>
<h3 id="packetmaploader-1">PacketMapLoader</h3>
<pre><code>public class PacketMapLoader : ILaunchTask
{
    [Inject] private readonly IPacketMap _packetMap;

    public int ExecuteOrder =&gt; -1;

    public async UniTask Execute()
    {
        var stopwatch = new Stopwatch();
        stopwatch.Start();

        var messageTypes = new Dictionary&lt;Type, ushort&gt;();
        var parsers = new Dictionary&lt;ushort, MessageParser&gt;();

        var packetMapData = new PacketMapData();
        await UniTask.WhenAll(packetMapData.Init(messageTypes, parsers));
        _packetMap.InitMessages(messageTypes, parsers);

        stopwatch.Stop();
        Debug.LogFormat(
            $&quot;&lt;color=yellow&gt;PacketMapLoader Execute cost:{stopwatch.Elapsed.TotalMilliseconds}&lt;/color&gt;&quot;);
    }
}
</code></pre><h3 id="packetmapdata-1">PacketMapData</h3>
<pre><code>public class PacketMapData
{ 
    public async UniTask Init(Dictionary&lt;Type, ushort&gt; messageTypes, Dictionary&lt;ushort, MessageParser&gt; parsers)
    {
        messageTypes.Add(typeof(Protocols.Messages.Login.LoginToLSReq), 1001);
        var parser1 = Protocols.Messages.Login.LoginToLSReq.Parser;
        parsers.Add(1001, parser1);
        await UniTask.WaitUntil(() =&gt; parser1 != null);
        ...
        ...
        messageTypes.Add(typeof(Protocols.Messages.Activity.NewYearBuyRes), 2601);
        var parser254 = Protocols.Messages.Activity.NewYearBuyRes.Parser;
        parsers.Add(2601, parser254);
        await UniTask.WaitUntil(() =&gt; parser254 != null);

    }
}
</code></pre><p>这个异步优化代码也有可以优化的空间，每次都等异步太浪费了，增加了耗时，最好是打包几个消息确定具体时间后异步等对应时间可能会更好。</p>
<h2 id="packetmapcreatecs">PacketMapCreate.cs</h2>
<pre><code>[MenuItem(&quot;Tools/PacketMapCreate&quot;)]
public static void Create()
{
    var csText = Header;
    var index = 0;
    foreach (FieldDescriptor fieldDescriptor
        in Messages.Descriptor.Fields.InDeclarationOrder())
    {
        csText += $&quot;\t\t\tmessageTypes.Add(typeof({fieldDescriptor.MessageType.ClrType.FullName}), {fieldDescriptor.FieldNumber});\n&quot;;
        var parser = $&quot;parser{++index}&quot;;
        csText += $&quot;\t\t\tvar {parser} = {fieldDescriptor.MessageType.ClrType.FullName + &quot;.Parser&quot;};\n&quot;;
        csText += $&quot;\t\t\tparsers.Add({fieldDescriptor.FieldNumber}, {parser});\n&quot;;
//                csText += $&quot;\t\t\tawait UniTask.WaitUntil(() =&gt; {parser} != null);\n&quot;;
        csText += &quot;\n&quot;;
    }

    csText += Bottom;
    var path = Path.Combine(Application.dataPath, &quot;PuzzlesKingdom/Scripts/PacketMap/PacketMapData.cs&quot;);
    File.WriteAllText(path, csText);
}
</code></pre>
      </article>
      
    </main>
    <nav class="end-nav side-padding">
      
    </nav>
    <footer class="side-padding" style="background-image: url('http://wwnje.github.io/img/home-blob-flip.svg');">
    <a href="http://wwnje.github.io/" class="footer-link">
    
        <img class="footer-icon" src="http://wwnje.github.io/icons/home-page.png">
    
    </a>
    
    <a href="http://github.com/wwnje" class="footer-link">
    
        <img class="footer-icon" src="http://wwnje.github.io/icons/github.png" />
    
    </a>
    
    
    <a href="http://linkedin.com/in/wwnje" class="footer-link">
    
        <img class="footer-icon" src="http://wwnje.github.io/icons/linkedin.png" />
    
    </a>
    
</footer>
    
  <script defer src="http://wwnje.github.io/js/katex.js"></script>


  <script defer src="http://wwnje.github.io/js/auto-render.js" onload="renderMathInElement(document.body);"></script>


<script src="http://wwnje.github.io/js/core.min.js"></script>

  </body>
</html>
